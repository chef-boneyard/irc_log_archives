[2013-04-23 00:35:19 -0400] seltzd: Hey there, I'm going through the 'gettingstartedwithchef.com' tutorial, and have a newbie question: Why does chef seem so picky about not inserting spaces?
[2013-04-23 00:35:55 -0400] seltzd: for example, if I do "  cwd node ['phpapp']['path']" it doesn't work, but if I do "  cwd node['phpapp']['path']" it works
[2013-04-23 00:36:32 -0400] seltzd: I'm a bit confused since I thought ruby in general isn't too picky about spaces.
[2013-04-23 14:49:01 -0400] UForgotten: seltzd: you can't put a space in between an array name and its element reference, that would be like saying $variable [element] in another language and expecting it to return $variable[element] 
[2013-04-23 14:55:00 -0400] UForgotten: spaces before and after statements don't much matter, but spacing inside syntax does matter.
[2013-04-23 14:56:35 -0400] dillyjay: how can i specify that a resource provider should only run the action if it is the first chef run? use case: i'm using the composer provider from: https://github.com/jolicode/chef-cookbook-php to :create_project, but this causes composer, and consequently the chef run, to fail if the project has already been created
[2013-04-23 14:57:17 -0400] dillyjay: should i be doing some sort of check like "if directory does not exist OR if directory is empty, then run this action"? that would seem to violate idempotence
[2013-04-23 14:58:15 -0400] UForgotten: dillyjay: you can look for something that the provider would have completed on success and add an only_if !condition so that if it has been done it will skip this action. may not be good style but it works :)
[2013-04-23 14:58:23 -0400] UForgotten: EOF in archive means your tar is corrupt
[2013-04-23 14:58:56 -0400] UForgotten: if you're using shared drives in vagrant they can be flakey
[2013-04-23 15:00:18 -0400] dillyjay: UForgotten: hadn't thought of it that way, thanks. i know this could be found searching docs, but would you be so kind as to tell me how to make sure a directory either doesn't exist or is empty?
[2013-04-23 15:01:15 -0400] dillyjay: or maybe just a link to the appropriate portion of the docs
[2013-04-23 15:01:34 -0400] UForgotten: this is what I use
[2013-04-23 15:01:35 -0400] UForgotten: only_if "! [[ -d /this/directory/should/exist/if/not/dont/run/this/recipe ]]"
[2013-04-23 15:02:25 -0400] UForgotten: the logic can be confusing but basically it says ONLY run this recipe if the directory does not exist
[2013-04-23 15:02:42 -0400] UForgotten: so if the directory exists, skip it
[2013-04-23 15:02:47 -0400] UForgotten: make sense?
[2013-04-23 15:03:45 -0400] UForgotten: again, YMMV, TMTOWTDI, etc :)
[2013-04-23 15:05:49 -0400] dillyjay: that part makes sense, implementing the "OR" part is what i'm having trouble with
[2013-04-23 15:06:43 -0400] UForgotten: not sure what you need or for, you just put only_if at the end of the recipe and ruby makes it a condition for execution
[2013-04-23 15:07:01 -0400] dillyjay: or i guess more accurately, i'm looking for 'only_if' {"// shell script for dira does not exist" && "shell script for dira is empty"}
[2013-04-23 15:07:30 -0400] UForgotten: http://docs.opscode.com/essentials_cookbook_resources_first_run.html
[2013-04-23 15:08:00 -0400] dillyjay: so there are two possible scenarios in which i want the :action to run A) the directory doesn't exist or B) the directory is empty
[2013-04-23 15:08:38 -0400] dillyjay: that was supposed to be a B )
[2013-04-23 15:08:39 -0400] UForgotten: ah. you can combine two [[ ]]] tests with || 
[2013-04-23 15:09:34 -0400] UForgotten: but checking directory empty may not be clean with a [[ ]] test 
[2013-04-23 15:09:49 -0400] UForgotten: empty as in 0 bytes, or empty as in no files? you could do an ls -l | wc -l or somesuch 
[2013-04-23 15:11:15 -0400] dillyjay: empty as in no files.
[2013-04-23 15:13:56 -0400] dillyjay: so like 'not_if  {Directory.exists?("/my/dir") ||  "ls -A /my/dir"} end'?
[2013-04-23 15:14:53 -0400] dillyjay: wait, i may be overcomplicating this. would 'not_if do "ls -A /my/dir" end' work, since it would be a negative result on both counts (A. directory doesn't exist B. no files in directory)
[2013-04-23 15:16:29 -0400] UForgotten: makes sense but ls -A emptydir still returns 0.
[2013-04-23 15:17:04 -0400] UForgotten: and a missing file returns 2. so that will not work the way you expect.
[2013-04-23 15:17:37 -0400] UForgotten: thats one frustrating thing about config management, it seems like these are problems that would have been solved eleventybillion times already
[2013-04-23 15:17:50 -0400] UForgotten: just have to find all the pieces to the puzzle :)
[2013-04-23 15:18:49 -0400] UForgotten: BTW I still have a LOT to learn myself, so apologies if I mislead you, but that's what open source collaboration is all about (helping each other learn)
[2013-04-23 15:19:39 -0400] dillyjay: not at all, any help is appreciated
[2013-04-23 15:20:43 -0400] dillyjay: man, nagios cookbook doesn't work with chef-solo? that's kinda lame
[2013-04-23 15:23:15 -0400] UForgotten: I use chef-solo and it definitely changes the mindset a little. Especially when it comes to first run problems. you basically have to check state every time since there's no chef server to set the state on.
[2013-04-23 15:25:42 -0400] dillyjay: have you used chef-server and chef-client? i figured i'd start with solo because it would lessen the learning curve, but if it's crippling then i guess i might as well go to server-client
[2013-04-23 15:26:43 -0400] behemphi: I love the server
[2013-04-23 15:27:10 -0400] behemphi: knife ssh 'role:webhost' 'ps -eo pmem,pcpu' | grep uwsgi'
[2013-04-23 15:27:14 -0400] UForgotten: I haven't gotten to use client/server yet no.  have not been able to justify the overhead
[2013-04-23 15:27:16 -0400] behemphi: tha tpretty much says it all
[2013-04-23 15:28:52 -0400] dillyjay: that's another reason i'm on solo, just trying it with one or two projects
[2013-04-23 15:29:43 -0400] dillyjay: UForgotten: by the way, this worked 'not_if do "ls -A /my/dir" end'
[2013-04-23 15:30:28 -0400] UForgotten: dillyjay: I don't think that is right
[2013-04-23 15:30:38 -0400] dillyjay: well, worked with a directory that had contents. haven't tried on non-existent yet.
[2013-04-23 15:31:02 -0400] UForgotten: it won't work for the empty case.
[2013-04-23 15:32:01 -0400] dillyjay: let me try
[2013-04-23 15:36:07 -0400] dillyjay: ok, yeah, that didn't work. so it correctly skips the execution if the dir isn't empty, but incorrectly skips the execution if the dir is empty 
[2013-04-23 15:37:21 -0400] dillyjay: is this what you were suggesting (don't know if the syntax is correct)           only_if "! [[ -d /my/dir]] || ! [[ ls -A /my/dir ]]"
[2013-04-23 15:37:44 -0400] UForgotten: that type of syntax will make your head asplode
[2013-04-23 15:38:28 -0400] dillyjay: yeah, that's the problem, i don't know whether to use {} or "[[]]" or what
[2013-04-23 15:38:42 -0400] UForgotten: may be useful to dig around the docs and see if there's a better way to do it. http://docs.opscode.com/chef/resources.html#only-if-examples
[2013-04-23 15:38:54 -0400] UForgotten: one thought I had would be to make the run one recipe be a action :nothing 
[2013-04-23 15:39:11 -0400] UForgotten: then have another recipe  to notify it to execute if both tests pass
[2013-04-23 15:39:52 -0400] dillyjay: yeah, i'm looking at the not_if and only_if examples right now, but there don't appear to be any with multiple conditions
[2013-04-23 15:40:33 -0400] dillyjay: maybe i should separate the directory portion into a directory resource, so the only logic i have to deal with in this action is whether or not the directory is empty
[2013-04-23 15:42:23 -0400] UForgotten: it looks like you can pass only_if a block so you can do your checks in a block between do end and return true or false
[2013-04-23 15:44:28 -0400] dillyjay: ok, i need to slow down, what is the appropriate way to ensure a directory is empty, if not "ls -A /my/dir"?
[2013-04-23 15:54:50 -0400] UForgotten: dillyjay: unfortunately there are many ways to do it. 
[2013-04-23 15:55:20 -0400] dillyjay: that's why i was asking :) i've got this: http://stackoverflow.com/questions/4253698/how-to-check-if-folder-is-empty-or-have-folder-file-use-shell-script and this http://stackoverflow.com/questions/4253698/how-to-check-if-folder-is-empty-or-have-folder-file-use-shell-script
[2013-04-23 15:58:28 -0400] dillyjay: which both have the array approach as accepted answers. but i was hoping for something more simple, i.e. not having to pass a block
[2013-04-23 15:59:54 -0400] UForgotten: well I do know that having lots of logical operators is a bad idea for readability and debugging
[2013-04-23 16:02:38 -0400] UForgotten: sorry I'm not offering much help, I struggle with TMTOWTDI a lot myself.
[2013-04-23 16:03:02 -0400] UForgotten: comes down to trial and error, hopefully not mostly error :)
[2013-04-23 16:04:26 -0400] UForgotten: oh
[2013-04-23 16:04:33 -0400] UForgotten: maybe there's a ruby method for it
[2013-04-23 16:05:01 -0400] UForgotten: Dir['your_directory/*'].empty?
[2013-04-23 16:05:54 -0400] UForgotten: doesn't work right in irb for me though.
[2013-04-23 16:06:40 -0400] dillyjay: my ruby skills are non-existent
[2013-04-23 16:06:50 -0400] UForgotten: same here lol
[2013-04-23 16:07:01 -0400] dillyjay: i thought the manual said you didn't need to know ruby to use chef?! :)
[2013-04-23 16:07:10 -0400] UForgotten: wat
[2013-04-23 16:07:29 -0400] dillyjay: http://docs.opscode.com/just_enough_ruby_for_chef.html
[2013-04-23 16:07:30 -0400] UForgotten: you don't have to know how to shift gears to drive a car
[2013-04-23 16:08:44 -0400] dillyjay: what would be really cool is if the directory resource had an :empty attribute
[2013-04-23 16:09:46 -0400] UForgotten: this should work not_if Dir.entries('/full/path/to/dir/').size > 0
[2013-04-23 16:09:50 -0400] dillyjay: ok so this ugly little line appears to be working: only_if "! [[ -z `ls /my/dir/*` ]]"
[2013-04-23 16:10:07 -0400] UForgotten: but that will error if directory doesn't exist lol
[2013-04-23 16:10:36 -0400] dillyjay: i separated the directory into another resource
[2013-04-23 16:11:00 -0400] dillyjay: so first i'm running the directory resource :create, then the provider action
[2013-04-23 16:11:28 -0400] UForgotten: crap that .size includes . and ..
[2013-04-23 16:12:13 -0400] dillyjay: maybe .entires('/my/dir/*'), but that would not only exclude . and .. but all hidden files
[2013-04-23 16:12:43 -0400] dillyjay: i'm sure there's a simple regex that would work, but my regex knowledge is about as good as my ruby knowledge
[2013-04-23 16:14:08 -0400] dillyjay: really i think it's a problem with the provider's action. i would think that the action should define the conditional statement
[2013-04-23 16:28:16 -0400] dillyjay: ooooh, duh. obviously this isn't a good fix, but why not just do not_if Dir.entries('/full/path/to/dir/').size > 2
[2013-04-23 16:38:12 -0400] Eiam: is it Chef's place to setup my VM like, create directory paths that I want to exist, setup my .bash_profile & so on?
[2013-04-23 16:38:19 -0400] Eiam: or is that the responsibility of vagrant?
[2013-04-23 16:42:24 -0400] dillyjay: chef
[2013-04-23 16:43:51 -0400] dillyjay: UForgotten: ok, don't know if you're interested, and this should really not have taken me so long, but what seems to work is if(Dir.entries('/my/dir') - %w{ . .. }).empty?  end
[2013-04-23 17:13:54 -0400] UForgotten: dillyjay: I did see that on one of the stackoverflows, makes sense. 
[2013-04-23 22:37:09 -0400] grant1: anyone using the rvm cookbook?
[2013-04-23 22:38:15 -0400] grant1: or really any recipe that expects a hash for an attribute you might want to set in a role definition. I can't quite figure out how to pass it correctly from the json
[2013-04-23 22:55:37 -0400] acts_as_coder: grant1  maybe try just creating the desired hash and then convert it to json with ruby?
[2013-04-23 22:55:37 -0400] acts_as_coder: Like this from irb 
[2013-04-23 22:55:37 -0400] acts_as_coder: require 'json'
[2013-04-23 22:55:38 -0400] acts_as_coder: JSON.pretty_generate({:id => 1, :name => 'Test', :something => 'else'})
[2013-04-23 22:56:21 -0400] acts_as_coder: That should get you some nice looking json. Is that what you're looking for or is it not clear what the hash structure should be for the rvm cookbook attributes you're trying to set?
[2013-04-23 23:42:14 -0400] grant1: acts_as_coder: more the latter. So I'm trying to accomplish something along these lines inside the role: http://hastebin.com/hefiyedolu.coffee
